# å›½å†…æœŸè´§Kçº¿èšåˆæŒ‡å—

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-17

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

å›½å†…æœŸè´§æœ‰**ç‰¹æ®Šçš„äº¤æ˜“æ—¶æ®µå’Œå°èŠ‚ä¼‘æ¯**æœºåˆ¶ï¼Œå¯¼è‡´ç®€å•çš„"æ¯30åˆ†é’Ÿåˆ‡åˆ†"é€»è¾‘æ˜¯**é”™è¯¯çš„**ã€‚

### âŒ é”™è¯¯åšæ³•
```dart
// ç®€å•æŒ‰ç…§æ—¶é—´æ¯30åˆ†é’Ÿåˆ‡åˆ†ï¼ˆä¸è€ƒè™‘äº¤æ˜“æ—¶æ®µï¼‰
final period = DateTime(time.year, time.month, time.day, time.hour, (time.minute ~/ 30) * 30);
```

**é—®é¢˜**ï¼š
- 10:15-10:30 æ˜¯å°èŠ‚ä¼‘æ¯ï¼Œæ²¡æœ‰äº¤æ˜“
- ç›´æ¥åˆ‡åˆ†ä¼šå¯¼è‡´ 10:00-10:30 åŒ…å«äº† 10:15-10:30 çš„ä¼‘æ¯æ—¶æ®µ
- ä¸é€šè¾¾ä¿¡ã€æ–‡åè´¢ç»ç­‰ä¸“ä¸šè½¯ä»¶çš„Kçº¿å¯¹ä¸é½

### âœ… æ­£ç¡®åšæ³•
ä¸¥æ ¼éµå¾ª**å›½å†…æœŸè´§äº¤æ˜“æ—¶æ®µ**ï¼Œåœ¨æ¯ä¸ªæ—¶æ®µè¾¹ç•Œå¼ºåˆ¶æ–­å¼€ã€‚

---

## ğŸ¯ å›½å†…æœŸè´§äº¤æ˜“æ—¶æ®µ

### æ—¥ç›˜
```
09:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 10:15  (ç¬¬ä¸€å°èŠ‚)
        [10:15 - 10:30 ä¼‘æ¯]
10:30 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 11:30  (ç¬¬äºŒå°èŠ‚)
        [11:30 - 13:30 åˆä¼‘]
13:30 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 15:00  (ä¸‹åˆç›˜)
```

### å¤œç›˜
```
åŸºç¡€å“ç§ï¼ˆèºçº¹é’¢ã€é“çŸ¿çŸ³ç­‰ï¼‰:
21:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 23:00

å»¶é•¿å“ç§ï¼ˆé“œã€é»„é‡‘ç­‰ï¼‰:
21:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 01:00

æœ€é•¿å“ç§ï¼ˆé»„é‡‘ï¼‰:
21:00 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 02:30
```

---

## ğŸ“Š 30åˆ†é’ŸKçº¿åˆ‡åˆ†è§„åˆ™

### æ ‡å‡†å‘¨æœŸï¼ˆ6ä¸ª5åˆ†é’Ÿï¼‰
```
09:00 - 09:30  âœ… 6ä¸ª5åˆ†é’Ÿ
09:30 - 10:00  âœ… 6ä¸ª5åˆ†é’Ÿ
10:30 - 11:00  âœ… 6ä¸ª5åˆ†é’Ÿ
11:00 - 11:30  âœ… 6ä¸ª5åˆ†é’Ÿ
13:30 - 14:00  âœ… 6ä¸ª5åˆ†é’Ÿ
14:00 - 14:30  âœ… 6ä¸ª5åˆ†é’Ÿ
14:30 - 15:00  âœ… 6ä¸ª5åˆ†é’Ÿ
21:00 - 21:30  âœ… 6ä¸ª5åˆ†é’Ÿ
21:30 - 22:00  âœ… 6ä¸ª5åˆ†é’Ÿ
22:00 - 22:30  âœ… 6ä¸ª5åˆ†é’Ÿ
22:30 - 23:00  âœ… 6ä¸ª5åˆ†é’Ÿ
```

### âš ï¸ ç‰¹æ®Šå‘¨æœŸï¼ˆ3ä¸ª5åˆ†é’Ÿï¼‰
```
10:00 - 10:15  âš ï¸ åªæœ‰3ä¸ª5åˆ†é’Ÿï¼
```

**åŸå› **ï¼š10:15-10:30 æ˜¯å°èŠ‚ä¼‘æ¯ï¼Œå¿…é¡»åœ¨ 10:15 å¼ºåˆ¶æ–­å¼€ã€‚

---

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### Dartç‰ˆæœ¬ï¼ˆFlutter Appä¸­ä½¿ç”¨ï¼‰

#### 1. å¯¼å…¥å·¥å…·ç±»
```dart
import 'package:futures_replay/utils/kline_aggregator.dart';
```

#### 2. èšåˆ5åˆ†é’Ÿåˆ°30åˆ†é’Ÿ
```dart
// å‡è®¾ä½ æœ‰ä¸€ä¸ª5åˆ†é’ŸKçº¿åˆ—è¡¨
List<KlineModel> data5min = [...];

// èšåˆä¸º30åˆ†é’Ÿ
List<KlineModel> data30min = KlineAggregator.aggregate5MinTo30Min(data5min);

print('è¾“å…¥: ${data5min.length} æ ¹5åˆ†é’ŸKçº¿');
print('è¾“å‡º: ${data30min.length} æ ¹30åˆ†é’ŸKçº¿');
```

#### 3. åœ¨ReplayEngineä¸­é›†æˆ
```dart
// lib/engine/replay_engine.dart

import '../utils/kline_aggregator.dart';

class ReplayEngine extends ChangeNotifier {
  // ... å…¶ä»–ä»£ç  ...
  
  /// åˆ‡æ¢å‘¨æœŸ
  void changePeriod(Period newPeriod) {
    _currentPeriod = newPeriod;
    
    if (newPeriod == Period.m30) {
      // ä»5åˆ†é’Ÿèšåˆä¸º30åˆ†é’Ÿ
      _aggregatedData = KlineAggregator.aggregate5MinTo30Min(_rawData5min);
    } else if (newPeriod == Period.h1) {
      // å¯ä»¥ç»§ç»­æ‰©å±•60åˆ†é’Ÿèšåˆ
      _aggregatedData = KlineAggregator.aggregate5MinTo60Min(_rawData5min);
    }
    
    notifyListeners();
  }
}
```

---

### Pythonç‰ˆæœ¬ï¼ˆæ•°æ®é¢„å¤„ç†ï¼‰

#### 1. ä½¿ç”¨è„šæœ¬
```bash
# ä»CSVæ–‡ä»¶è¯»å–5åˆ†é’Ÿæ•°æ®ï¼Œèšåˆä¸º30åˆ†é’Ÿ
python scripts/kline_aggregator.py input_5min.csv output_30min.csv
```

#### 2. åœ¨ä»£ç ä¸­ä½¿ç”¨
```python
import pandas as pd
from kline_aggregator import KlineAggregator

# è¯»å–5åˆ†é’Ÿæ•°æ®
df_5min = pd.read_csv('rb_5min.csv')

# èšåˆä¸º30åˆ†é’Ÿ
df_30min = KlineAggregator.aggregate_5min_to_30min(df_5min)

# ä¿å­˜
df_30min.to_csv('rb_30min.csv', index=False)
```

#### 3. åœ¨GitHub Actionsä¸­é¢„å¤„ç†
```yaml
# .github/workflows/fetch-data.yml

- name: Aggregate to different periods
  run: |
    # èšåˆä¸º30åˆ†é’Ÿ
    python scripts/kline_aggregator.py \
      incremental/RB/RB_5min_20260217.csv \
      incremental/RB/RB_30min_20260217.csv
    
    # èšåˆä¸º60åˆ†é’Ÿ
    python scripts/kline_aggregator.py \
      incremental/RB/RB_5min_20260217.csv \
      incremental/RB/RB_60min_20260217.csv
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### Dartæµ‹è¯•
```bash
# è¿è¡ŒDartæµ‹è¯•
dart run lib/utils/kline_aggregator.dart
```

**æœŸæœ›è¾“å‡º**:
```
=== æµ‹è¯•å›½å†…æœŸè´§5åˆ†é’Ÿèšåˆä¸º30åˆ†é’Ÿ ===

è¾“å…¥: 69 æ ¹5åˆ†é’ŸKçº¿
æ—¶é—´èŒƒå›´: 2024-01-05 09:00:00.000 ~ 2024-01-05 22:55:00.000

è¾“å‡º: 16 æ ¹30åˆ†é’ŸKçº¿

è¯¦ç»†ç»“æœ:
--------------------------------------------------------------------------------
åºå· | æ—¶é—´          | å¼€ç›˜   | æœ€é«˜   | æœ€ä½   | æ”¶ç›˜   | æˆäº¤é‡
--------------------------------------------------------------------------------
 1 | 09:00 | 3800.00 | 3807.00 | 3793.00 | 3800.00 | 6300
 2 | 09:30 | 3806.00 | 3813.00 | 3799.00 | 3806.00 | 6600
 3 | 10:00 | 3812.00 | 3817.00 | 3805.00 | 3812.00 | 3450  â¬…ï¸ æ³¨æ„è¿™é‡Œåªæœ‰3ä¸ª5åˆ†é’Ÿ
 4 | 10:30 | 3815.00 | 3828.00 | 3808.00 | 3821.00 | 7200
...
--------------------------------------------------------------------------------

éªŒè¯å…³é”®å‘¨æœŸ:
âœ… 09:00 å‘¨æœŸå­˜åœ¨
âœ… 09:30 å‘¨æœŸå­˜åœ¨
âœ… 10:00 å‘¨æœŸå­˜åœ¨
âœ… 10:30 å‘¨æœŸå­˜åœ¨
âœ… 11:00 å‘¨æœŸå­˜åœ¨
âœ… 13:30 å‘¨æœŸå­˜åœ¨
âœ… 21:00 å‘¨æœŸå­˜åœ¨
```

### Pythonæµ‹è¯•
```bash
python scripts/kline_aggregator.py
```

---

## ğŸ“ èšåˆç®—æ³•ç»†èŠ‚

### æ ¸å¿ƒé€»è¾‘
```
å¯¹äºæ¯æ ¹5åˆ†é’ŸKçº¿:
  1. ç¡®å®šå®ƒåº”è¯¥å±äºå“ªä¸ª30åˆ†é’Ÿå‘¨æœŸ
     period_start = _get_30min_period_start(time)
  
  2. å¦‚æœæ˜¯æ–°å‘¨æœŸçš„å¼€å§‹ï¼Œå…ˆç»“æŸä¸Šä¸€ä¸ªå‘¨æœŸ
     if period_start != current_period:
        ç»“æŸå¹¶è¾“å‡ºä¸Šä¸€ä¸ªå‘¨æœŸçš„30åˆ†é’ŸKçº¿
        å¼€å§‹æ–°å‘¨æœŸ
  
  3. å°†å½“å‰5åˆ†é’ŸKçº¿åŠ å…¥ç¼“å†²åŒº
     buffer.add(kline)
  
  4. ç»§ç»­ä¸‹ä¸€æ ¹5åˆ†é’ŸKçº¿
```

### å‘¨æœŸåˆ¤æ–­æ ¸å¿ƒä»£ç 
```dart
DateTime _get_30min_period_start(DateTime time) {
  final hour = time.hour;
  final minute = time.minute;
  
  // 09:00-09:30
  if (hour == 9 && minute < 30) {
    return DateTime(time.year, time.month, time.day, 9, 0);
  }
  
  // 09:30-10:00
  if (hour == 9 && minute >= 30) {
    return DateTime(time.year, time.month, time.day, 9, 30);
  }
  
  // 10:00-10:15 (ç‰¹æ®Šï¼)
  if (hour == 10 && minute < 15) {
    return DateTime(time.year, time.month, time.day, 10, 0);
  }
  
  // ... å…¶ä»–æ—¶æ®µ ...
}
```

### åˆå¹¶è§„åˆ™
```dart
KlineModel _mergeKlines(List<KlineModel> klines, DateTime periodStart) {
  return KlineModel(
    time: periodStart,              // æ—¶é—´æˆ³ä½¿ç”¨å‘¨æœŸå¼€å§‹æ—¶é—´
    open: klines.first.open,        // å¼€ç›˜ä»·å–ç¬¬ä¸€æ ¹
    close: klines.last.close,       // æ”¶ç›˜ä»·å–æœ€åä¸€æ ¹
    high: klines.map((k) => k.high).max,  // æœ€é«˜ä»·å–æœ€é«˜
    low: klines.map((k) => k.low).min,    // æœ€ä½ä»·å–æœ€ä½
    volume: klines.sum((k) => k.volume),  // æˆäº¤é‡æ±‚å’Œ
  );
}
```

---

## ğŸ¯ å…³é”®æ³¨æ„äº‹é¡¹

### 1. 10:00-10:15 ç‰¹æ®Šå¤„ç† âš ï¸
```
è¿™æ˜¯æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ï¼

é”™è¯¯ï¼š10:00-10:30 åŒ…å«6ä¸ª5åˆ†é’Ÿ (10:00, 10:05, 10:10, 10:15, 10:20, 10:25)
æ­£ç¡®ï¼š
  - 10:00-10:15 åŒ…å«3ä¸ª5åˆ†é’Ÿ (10:00, 10:05, 10:10)
  - 10:15-10:30 æ˜¯ä¼‘æ¯æ—¶é—´ï¼Œæ²¡æœ‰Kçº¿
  - 10:30-11:00 åŒ…å«6ä¸ª5åˆ†é’Ÿ (10:30, 10:35, 10:40, 10:45, 10:50, 10:55)
```

### 2. å¤œç›˜è·¨æ—¥å¤„ç†
```dart
// 23:30-00:00 ä¼šè·¨æ—¥
if (hour == 23 && minute >= 30) {
  return DateTime(time.year, time.month, time.day, 23, 30);
}

// 00:00-00:30 (ç¬¬äºŒå¤©)
if (hour == 0 && minute < 30) {
  return DateTime(time.year, time.month, time.day, 0, 0);
}
```

### 3. ä¸åŒå“ç§çš„å¤œç›˜æ—¶é•¿
```
èºçº¹é’¢(RB)ã€é“çŸ¿çŸ³(I): 21:00 - 23:00
é“œ(CU)ã€é“(AL):        21:00 - 01:00
é»„é‡‘(AU)ã€ç™½é“¶(AG):    21:00 - 02:30
```

**å»ºè®®**ï¼šå…ˆæ”¯æŒåˆ°23:00ï¼Œåç»­æ ¹æ®å“ç§æ‰©å±•ã€‚

---

## ğŸ”§ æ‰©å±•ï¼š60åˆ†é’Ÿèšåˆ

å¦‚æœéœ€è¦60åˆ†é’ŸKçº¿ï¼Œå¯ä»¥ç±»ä¼¼å®ç°ï¼š

```dart
static List<KlineModel> aggregate5MinTo60Min(List<KlineModel> source) {
  // è§„åˆ™ï¼š
  // 09:00 - 10:00 (12ä¸ª5min)
  // 10:30 - 11:30 (12ä¸ª5min) âš ï¸ è·³è¿‡10:00-10:15å’Œ10:15-10:30
  // 13:30 - 14:30 (12ä¸ª5min)
  // 14:30 - 15:00 (6ä¸ª5min) âš ï¸ ç‰¹æ®Š
  // 21:00 - 22:00 (12ä¸ª5min)
  // 22:00 - 23:00 (12ä¸ª5min)
  
  // å®ç°é€»è¾‘...
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å¤§æ•°æ®é‡å¤„ç†
```dart
// å¦‚æœ5åˆ†é’Ÿæ•°æ®é‡å¾ˆå¤§ï¼ˆå¦‚10ä¸‡æ ¹ï¼‰ï¼Œå»ºè®®åˆ†æ‰¹èšåˆ
List<KlineModel> aggregateLargeDataset(List<KlineModel> source) {
  final chunkSize = 10000;
  final results = <KlineModel>[];
  
  for (int i = 0; i < source.length; i += chunkSize) {
    final end = (i + chunkSize < source.length) ? i + chunkSize : source.length;
    final chunk = source.sublist(i, end);
    results.addAll(KlineAggregator.aggregate5MinTo30Min(chunk));
  }
  
  // åˆå¹¶è¾¹ç•Œå¤„çš„Kçº¿
  return _mergeBoundaryKlines(results);
}
```

### ç¼“å­˜ç­–ç•¥
```dart
// å·²èšåˆçš„æ•°æ®å¯ä»¥ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
class CachedAggregator {
  final _cache = <String, List<KlineModel>>{};
  
  List<KlineModel> aggregate(String symbol, Period period, List<KlineModel> source) {
    final cacheKey = '${symbol}_${period.name}_${source.length}';
    
    if (_cache.containsKey(cacheKey)) {
      return _cache[cacheKey]!;
    }
    
    final result = KlineAggregator.aggregate5MinTo30Min(source);
    _cache[cacheKey] = result;
    return result;
  }
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæˆ‘çš„30åˆ†é’ŸKçº¿å’Œé€šè¾¾ä¿¡å¯¹ä¸ä¸Šï¼Ÿ
**A**: æ£€æŸ¥10:00-10:15è¿™ä¸ªç‰¹æ®Šå‘¨æœŸã€‚é€šè¾¾ä¿¡ä¼šåœ¨10:15å¼ºåˆ¶æ–­å¼€ï¼Œå½¢æˆä¸€æ ¹åªæœ‰3ä¸ª5åˆ†é’Ÿçš„30åˆ†é’ŸKçº¿ã€‚

### Q2: å¤œç›˜æ•°æ®è·¨æ—¥äº†æ€ä¹ˆåŠï¼Ÿ
**A**: ä»£ç å·²ç»å¤„ç†äº†è·¨æ—¥æƒ…å†µã€‚23:30-00:00ä¼šæ­£ç¡®å½’å±åˆ°å‰ä¸€å¤©çš„23:30å‘¨æœŸã€‚

### Q3: ä¸åŒå“ç§çš„å¤œç›˜æ—¶é•¿ä¸ä¸€æ ·ï¼Ÿ
**A**: å½“å‰ä»£ç æ”¯æŒåˆ°23:00ã€‚å¦‚æœä½ çš„å“ç§å¤œç›˜æ›´é•¿ï¼ˆå¦‚é»„é‡‘åˆ°02:30ï¼‰ï¼Œä»£ç ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†å¯èƒ½éœ€è¦è°ƒæ•´ä¸€äº›è¾¹ç•Œæ¡ä»¶ã€‚

### Q4: èšåˆåæ•°æ®é‡å¤§æ¦‚æ˜¯å¤šå°‘ï¼Ÿ
**A**: 
- 5åˆ†é’Ÿ: ä¸€å¤©çº¦ 69æ ¹ï¼ˆæ—¥ç›˜45æ ¹ + å¤œç›˜24æ ¹ï¼‰
- 30åˆ†é’Ÿ: ä¸€å¤©çº¦ 16æ ¹
- æ¯”ä¾‹: çº¦ 1:4.3

### Q5: èƒ½å¦ç›´æ¥ä»1åˆ†é’Ÿèšåˆåˆ°30åˆ†é’Ÿï¼Ÿ
**A**: å¯ä»¥ï¼é€»è¾‘å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯è¾“å…¥æ•°æ®çš„ç²’åº¦æ›´ç»†ã€‚`_get_30min_period_start` å‡½æ•°å¯¹ä»»ä½•ç²’åº¦çš„è¾“å…¥éƒ½é€‚ç”¨ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. [ä¸Šæµ·æœŸè´§äº¤æ˜“æ‰€äº¤æ˜“æ—¶é—´](http://www.shfe.com.cn/)
2. [å¤§è¿å•†å“äº¤æ˜“æ‰€äº¤æ˜“æ—¶é—´](http://www.dce.com.cn/)
3. [éƒ‘å·å•†å“äº¤æ˜“æ‰€äº¤æ˜“æ—¶é—´](http://www.czce.com.cn/)
4. é€šè¾¾ä¿¡è½¯ä»¶Kçº¿èšåˆè§„åˆ™ï¼ˆé€†å‘å·¥ç¨‹ï¼‰

---

## ğŸ”„ ç‰ˆæœ¬å†å²

### v1.0 (2026-02-17)
- âœ… å®ç°5åˆ†é’Ÿåˆ°30åˆ†é’Ÿèšåˆ
- âœ… ä¸¥æ ¼éµå¾ªå›½å†…æœŸè´§äº¤æ˜“æ—¶æ®µ
- âœ… å¤„ç†10:00-10:15ç‰¹æ®Šå‘¨æœŸ
- âœ… æ”¯æŒå¤œç›˜è·¨æ—¥
- âœ… Dartå’ŒPythonåŒç‰ˆæœ¬

---

**æœ‰é—®é¢˜éšæ—¶é—®æˆ‘ï¼** ğŸš€
