# 观望按钮与推进模式同步修复

## 🐛 问题描述

用户反馈："观望按钮要和播放同步，都应该受推进模式影响"

**现象**：
- 播放按钮根据推进模式正确工作
- 但"观望"按钮（手动前进）始终调用 `next()`
- 导致手动前进和自动播放的行为不一致

## 📊 问题分析

### 修复前的行为

| 操作 | 按源K线推进 | 按周期推进 |
|------|-----------|-----------|
| 点击播放 ▶️ | 调用 next() ✅ | 调用 nextBar() ✅ |
| 点击观望 ⏭️ | 调用 next() ✅ | 调用 next() ❌ |

**问题**：观望按钮固定调用 `next()`，没有根据推进模式选择方法

### 期望的行为

| 操作 | 按源K线推进 | 按周期推进 |
|------|-----------|-----------|
| 点击播放 ▶️ | 调用 next() ✅ | 调用 nextBar() ✅ |
| 点击观望 ⏭️ | 调用 next() ✅ | 调用 nextBar() ✅ |

**目标**：观望按钮也要根据推进模式选择正确的方法

## ✅ 解决方案

### 修改观望按钮逻辑

**文件**: `lib/ui/screens/main_screen.dart`

```dart
// 修复前
_buildControlButton(
  '观望',
  Icons.skip_next,
  replay.isFinished ? null : () => replay.next(),  // ❌ 固定调用 next()
),

// 修复后
_buildControlButton(
  '观望',
  Icons.skip_next,
  replay.isFinished ? null : () {
    if (_advanceByPeriod) {
      replay.nextBar();  // ✅ 按周期推进
    } else {
      replay.next();     // ✅ 按源K线推进
    }
  },
),
```

## 🎮 行为说明

### 使用源K线推进模式

**播放**：定时器每 500ms 调用一次 `next()`
- 前进一根源K线（如1分钟）

**观望**：点击按钮调用 `next()`
- 前进一根源K线（如1分钟）
- ✅ 与播放行为一致

### 按照周期推进模式

**播放**：定时器调用 `nextBar()`
- 跳到下一根周期K线（如30分钟）
- 可能跳过多根源K线

**观望**：点击按钮调用 `nextBar()`
- 跳到下一根周期K线（如30分钟）
- ✅ 与播放行为一致

## 📐 技术实现

### 逻辑判断

使用 `_advanceByPeriod` 状态变量来决定调用哪个方法：

```dart
if (_advanceByPeriod) {
  replay.nextBar();  // 按周期推进：跳到下一根完整K线
} else {
  replay.next();     // 按源K线推进：前进一根源K线
}
```

### 方法区别

#### next() - 源K线推进
```dart
void next() {
  _currentIndex++;
  _processTick(_sourceData[_currentIndex]);  // 处理一根源K线
  _refreshDisplayCache();
  notifyListeners();
}
```
- 前进一根源K线
- O(1) 复杂度
- 快速执行

#### nextBar() - 周期推进
```dart
void nextBar() {
  while (...) {
    _currentIndex++;
    _processTick(_sourceData[_currentIndex]);
    
    // 直到遇到新的周期K线
    if (ghostBarChanged) break;
  }
  
  _refreshDisplayCache();
  notifyListeners();
}
```
- 循环处理多根源K线
- 直到完成一根完整的周期K线
- O(n) 复杂度（n = 周期内的源K线数量）

## 🎯 用户体验改进

### 一致性

**修复前**：
- 播放：按设置的模式工作 ✅
- 观望：总是源K线推进 ❌
- **不一致！**用户困惑

**修复后**：
- 播放：按设置的模式工作 ✅
- 观望：按设置的模式工作 ✅
- **一致！**符合用户预期

### 直观行为

**示例场景**：
1. 用户选择"按照周期推进"
2. 显示周期设置为30分钟
3. 点击播放：每次跳30分钟 ✅
4. 点击观望：也跳30分钟 ✅
5. **行为一致，符合直觉**

## 🧪 测试验证

### 测试1: 按源K线推进
1. 打开设置，选择"使用源K线推进"
2. 点击观望按钮
3. ✅ 应该前进一根源K线（如1分钟或5分钟）

### 测试2: 按周期推进
1. 打开设置，选择"按照周期推进"
2. 选择30分钟显示周期
3. 点击观望按钮
4. ✅ 应该跳到下一根30分钟K线

### 测试3: 播放和观望一致性
1. 选择任意推进模式
2. 点击播放，观察前进方式
3. 暂停
4. 点击观望
5. ✅ 前进方式应该和播放时一致

### 测试4: 模式切换
1. 选择"按周期推进"
2. 点击观望几次（应该跳跃式）
3. 切换到"使用源K线推进"
4. 再点击观望几次（应该连续式）
5. ✅ 行为应该立即改变

## 📊 完整的推进模式支持

现在所有的推进操作都支持模式选择：

| 操作 | 触发方式 | 推进逻辑 |
|------|---------|---------|
| 播放 ▶️ | 定时器自动 | ✅ 根据模式选择 |
| 观望 ⏭️ | 手动点击 | ✅ 根据模式选择 |
| 撤销 ↩️ | 手动点击 | 回退（不受影响） |

## 📁 修改的文件

1. ✅ `lib/ui/screens/main_screen.dart` - 修改观望按钮逻辑

## 💡 代码细节

### 观望按钮完整代码

```dart
_buildControlButton(
  '观望',                              // 按钮文字
  Icons.skip_next,                     // 图标
  replay.isFinished ? null : () {      // 回调函数
    if (_advanceByPeriod) {            // 🔧 根据推进模式
      replay.nextBar();                // 按周期推进
    } else {
      replay.next();                   // 按源K线推进
    }
  },
),
```

### 关键要点

1. **使用状态变量**：`_advanceByPeriod` 保存用户选择
2. **条件判断**：根据模式选择不同的方法
3. **即时生效**：模式改变后立即影响观望按钮
4. **保持一致**：与播放按钮逻辑完全一致

## 🎨 用户体验

### 按源K线推进（精细模式）

- 点击观望 → 前进1根源K线
- 播放 → 每 500ms 前进1根源K线
- **一致性**：手动和自动都是逐根推进

### 按周期推进（快速模式）

- 点击观望 → 跳到下一根周期K线
- 播放 → 定时跳到下一根周期K线
- **一致性**：手动和自动都是跳跃式

## 🔮 其他可能需要同步的操作

### 当前已同步
- ✅ 播放按钮（自动推进）
- ✅ 观望按钮（手动前进）

### 可能需要考虑的
- ⚪ 撤销按钮：应该不受影响（始终回退一根）
- ⚪ 快捷键：如果有键盘快捷键，也需要同步
- ⚪ 拖动进度条：直接设置索引，不受影响

## 📝 代码变更

### 变更内容
- 观望按钮从固定调用 `next()` 改为条件调用
- 根据 `_advanceByPeriod` 选择 `next()` 或 `nextBar()`

### 变更行数
- 新增：5 行
- 修改：1 行
- 总计：6 行

---

**修复完成时间**: 2026-02-17  
**问题类型**: 行为不一致  
**优先级**: 中（影响用户体验）  
**状态**: ✅ 已修复
