# å‘¨æœŸåˆ‡æ¢Bugä¿®å¤

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼š
- åœ¨5åˆ†é’Ÿå‘¨æœŸé€‰æ‹©CZSCæŒ‡æ ‡
- åˆ‡æ¢åˆ°30åˆ†é’Ÿå‘¨æœŸ
- ä¸»å›¾Kçº¿å˜å¾—éå¸¸æ‰å¹³ï¼Œå‡ ä¹çœ‹ä¸åˆ°ä»·æ ¼æ³¢åŠ¨

**æ ¹æœ¬åŸå› **ï¼š
åˆ‡æ¢å‘¨æœŸæ—¶ï¼Œæ—§å‘¨æœŸçš„CZSCæ•°æ®ï¼ˆç¬”å’Œä¸­æ¢ï¼‰æ²¡æœ‰è¢«æ¸…ç©ºï¼Œå¯¼è‡´ï¼š
1. æ—§æ•°æ®çš„æ—¶é—´èŒƒå›´ä¸æ–°å‘¨æœŸKçº¿ä¸åŒ¹é…
2. ç»˜åˆ¶æ—¶å°è¯•åœ¨é”™è¯¯çš„ä½ç½®ç»˜åˆ¶æ—§æ•°æ®
3. è™½ç„¶ä»·æ ¼èŒƒå›´è®¡ç®—æ­£å¸¸ï¼Œä½†è§†è§‰ä¸Šçœ‹èµ·æ¥å¼‚å¸¸

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ‡æ¢å‘¨æœŸæ—¶æ¸…ç©ºæ‰€æœ‰æŒ‡æ ‡æ•°æ®

**æ–‡ä»¶**ï¼š`lib/ui/screens/main_screen.dart`

```dart
void _switchPeriod(Period p) {
  if (p == _currentPeriod) return;
  int currentIdx = _replayEngine.currentProgress;
  _replayEngine.removeListener(_onReplayUpdate);
  _replayEngine.dispose();

  setState(() {
    _currentPeriod = p;
    _replayEngine = ReplayEngine(widget.allData, _currentPeriod, ...);
    _replayEngine.addListener(_onReplayUpdate);
    _isInitialized = false;
    
    // ğŸ”§ ä¿®å¤ï¼šæ¸…ç©ºæ‰€æœ‰æŒ‡æ ‡æ•°æ®ï¼Œé¿å…æ—§å‘¨æœŸæ•°æ®å½±å“æ–°å‘¨æœŸ
    _ma5 = [];
    _ma10 = [];
    _ma20 = [];
    _bollData = BOLLResult(upper: [], middle: [], lower: []);
    _czscData = CZSCResult(biList: [], zsList: [], fxList: []); // æ¸…ç©ºCZSC
    _macdData = MACDResult(dif: [], dea: [], macdBar: []);
    _kdjData = KDJResult(k: [], d: [], j: []);
    _rsiData = [];
    _wrData = [];
    _volMa5 = [];
    _volMa10 = [];
    
    _updateIndicators();
  });
}
```

### 2. æ·»åŠ CZSCæ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥

**æ–‡ä»¶**ï¼š`lib/ui/chart/kline_painter.dart`

æ·»åŠ äº† `_isCzscDataValid()` æ–¹æ³•ï¼š

```dart
/// æ£€æŸ¥CZSCæ•°æ®æ˜¯å¦æœ‰æ•ˆ
/// é˜²æ­¢åˆ‡æ¢å‘¨æœŸåä½¿ç”¨æ—§æ•°æ®å¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸
bool _isCzscDataValid() {
  if (czscData == null || allData.isEmpty) return false;
  
  // å¦‚æœCZSCæ•°æ®ä¸ºç©ºï¼Œè·³è¿‡
  if (czscData!.biList.isEmpty && czscData!.zsList.isEmpty) return false;
  
  // æ£€æŸ¥CZSCæ•°æ®çš„æ—¶é—´èŒƒå›´æ˜¯å¦åœ¨å½“å‰Kçº¿æ•°æ®èŒƒå›´å†…
  if (czscData!.biList.isNotEmpty) {
    final firstBi = czscData!.biList.first;
    final lastBi = czscData!.biList.last;
    final firstKlineTime = allData.first.time;
    final lastKlineTime = allData.last.time;
    
    // å¦‚æœç¬”çš„æ—¶é—´èŒƒå›´å®Œå…¨ä¸åœ¨å½“å‰Kçº¿èŒƒå›´å†…ï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
    if (lastBi.edt.isBefore(firstKlineTime) || 
        firstBi.sdt.isAfter(lastKlineTime)) {
      return false;
    }
  }
  
  return true;
}
```

### 3. åœ¨ç»˜åˆ¶å‰éªŒè¯æ•°æ®

```dart
// ===== ç»˜åˆ¶CZSCä¸­æ¢ =====
if (mainIndicator == MainIndicatorType.czsc && 
    czscData != null && 
    _isCzscDataValid()) { // ğŸ”§ æ·»åŠ æ•°æ®éªŒè¯
  _drawZsList(canvas, startIdx, endIdx, step, getY, chartHeight);
}

// ===== ç»˜åˆ¶CZSCç¬” =====
if (mainIndicator == MainIndicatorType.czsc && 
    czscData != null && 
    _isCzscDataValid()) { // ğŸ”§ æ·»åŠ æ•°æ®éªŒè¯
  _drawBiList(canvas, startIdx, endIdx, step, getY);
}
```

### 4. æ›´æ–°æ ‡ç­¾æ˜¾ç¤º

å½“CZSCæ•°æ®æ— æ•ˆæ—¶ï¼Œæ˜¾ç¤º"æ­£åœ¨è®¡ç®—..."ï¼š

```dart
if (_isCzscDataValid()) {
  // æ˜¾ç¤ºæ­£å¸¸çš„ç¬”å’Œä¸­æ¢æ•°é‡
  tp.text = TextSpan(children: [
    TextSpan(text: 'CZSC($dataCount): ', ...),
    TextSpan(text: 'ç¬”:${czscData!.biList.length} ', ...),
    TextSpan(text: 'ä¸­æ¢:${czscData!.zsList.length}', ...),
  ]);
} else {
  // æ•°æ®æ— æ•ˆï¼Œæ˜¾ç¤ºæç¤º
  tp.text = TextSpan(children: [
    TextSpan(text: 'CZSC: ', ...),
    TextSpan(text: 'æ­£åœ¨è®¡ç®—...', style: TextStyle(color: Colors.orange, ...)),
  ]);
}
```

## ğŸ” ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

### é—®é¢˜åˆ†æ

1. **åˆ‡æ¢å‘¨æœŸå‰**ï¼š
   - 5åˆ†é’Ÿå‘¨æœŸæœ‰200æ ¹Kçº¿
   - CZSCåˆ†æäº†è¿™200æ ¹Kçº¿ï¼Œç”Ÿæˆäº†ç¬”å’Œä¸­æ¢æ•°æ®
   - ç¬”çš„æ—¶é—´èŒƒå›´ï¼š2024-01-01 09:00 ~ 2024-01-01 17:00

2. **åˆ‡æ¢å‘¨æœŸå**ï¼š
   - 30åˆ†é’Ÿå‘¨æœŸåªæœ‰çº¦33æ ¹Kçº¿ï¼ˆ200/6ï¼‰
   - ReplayEngineé‡æ–°èšåˆæ•°æ®
   - ä½†CZSCæ•°æ®è¿˜æ˜¯æ—§çš„ï¼Œæ—¶é—´èŒƒå›´å’ŒKçº¿ä¸åŒ¹é…

3. **ç»˜åˆ¶æ—¶**ï¼š
   - `_findBarIndexByTime()` å°è¯•æ‰¾åˆ°ç¬”çš„èµ·ç‚¹å’Œç»ˆç‚¹
   - ç”±äºæ—¶é—´ä¸åŒ¹é…ï¼Œå¯èƒ½æ‰¾åˆ°é”™è¯¯çš„ç´¢å¼•
   - ç»˜åˆ¶ä½ç½®å¼‚å¸¸ï¼Œçœ‹èµ·æ¥å¾ˆæ‰å¹³

### æ•°æ®æµç¨‹

```
åˆ‡æ¢å‘¨æœŸ
    â†“
ReplayEngineé‡æ–°èšåˆ â†’ Kçº¿æ•°æ®æ›´æ–°ï¼ˆ30åˆ†é’Ÿï¼‰
    â†“
ä½†æ˜¯...
    â†“
CZSCæ•°æ®è¿˜æ˜¯æ—§çš„ â†’ æ—¶é—´èŒƒå›´æ˜¯5åˆ†é’Ÿçš„
    â†“
ç»˜åˆ¶æ—¶æ—¶é—´ä¸åŒ¹é… â†’ ä½ç½®é”™è¯¯ â†’ æ˜¾ç¤ºå¼‚å¸¸
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ åˆ‡æ¢å‘¨æœŸåKçº¿æ‰å¹³
- âŒ CZSCæ•°æ®æ˜¾ç¤ºå¼‚å¸¸
- âŒ å¯èƒ½å¯¼è‡´ç»˜åˆ¶é”™è¯¯

### ä¿®å¤å
- âœ… åˆ‡æ¢å‘¨æœŸæ—¶æ¸…ç©ºæ—§æ•°æ®
- âœ… ç»˜åˆ¶å‰éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
- âœ… æ•°æ®æ— æ•ˆæ—¶æ˜¾ç¤º"æ­£åœ¨è®¡ç®—..."
- âœ… Kçº¿æ˜¾ç¤ºæ­£å¸¸

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸å‘¨æœŸåˆ‡æ¢
1. åœ¨5åˆ†é’Ÿå‘¨æœŸé€‰æ‹©ä»»æ„æŒ‡æ ‡
2. åˆ‡æ¢åˆ°15åˆ†é’Ÿã€30åˆ†é’Ÿ
3. âœ… Kçº¿æ˜¾ç¤ºæ­£å¸¸

### åœºæ™¯2ï¼šCZSCå‘¨æœŸåˆ‡æ¢
1. åœ¨5åˆ†é’Ÿå‘¨æœŸé€‰æ‹©CZSCæŒ‡æ ‡
2. åˆ‡æ¢åˆ°30åˆ†é’Ÿå‘¨æœŸ
3. âœ… æ ‡ç­¾æ˜¾ç¤º"æ­£åœ¨è®¡ç®—..."
4. ç­‰å¾…è®¡ç®—å®Œæˆ
5. âœ… CZSCæ­£å¸¸æ˜¾ç¤º

### åœºæ™¯3ï¼šå¿«é€Ÿåˆ‡æ¢
1. åœ¨å¤šä¸ªå‘¨æœŸé—´å¿«é€Ÿåˆ‡æ¢
2. âœ… ä¸ä¼šå‡ºç°æ‰å¹³Kçº¿
3. âœ… æ•°æ®æ­£ç¡®åˆ·æ–°

## ğŸ¯ å…¶ä»–æŒ‡æ ‡çš„å½±å“

è™½ç„¶è¿™æ¬¡ä¸»è¦æ˜¯CZSCå¼•èµ·çš„é—®é¢˜ï¼Œä½†æ¸…ç©ºæ‰€æœ‰æŒ‡æ ‡æ•°æ®å¯¹å…¶ä»–æŒ‡æ ‡ä¹Ÿæœ‰å¥½å¤„ï¼š

### MA/EMA/BOLL
- å‘¨æœŸä¸åŒï¼Œå‡çº¿å‚æ•°å«ä¹‰ä¸åŒ
- æ¸…ç©ºåé‡æ–°è®¡ç®—ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®

### MACD/KDJ/RSI
- è¿™äº›æŒ‡æ ‡ä¹Ÿä¾èµ–Kçº¿æ•°æ®
- æ¸…ç©ºåé‡æ–°è®¡ç®—ï¼Œé¿å…æ½œåœ¨é—®é¢˜

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ€§èƒ½è€ƒè™‘

1. **è®¡ç®—å»¶è¿Ÿ**
   - åˆ‡æ¢å‘¨æœŸåéœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
   - CZSCè®¡ç®—å¯èƒ½éœ€è¦100-300ms
   - ç”¨æˆ·ä¼šçœ‹åˆ°"æ­£åœ¨è®¡ç®—..."æç¤º

2. **ä¼˜åŒ–æ–¹å‘**
   - å¯ä»¥è€ƒè™‘å¼‚æ­¥è®¡ç®—CZSC
   - æˆ–è€…æ˜¾ç¤ºè¿›åº¦æ¡
   - æˆ–è€…å…ˆæ˜¾ç¤ºKçº¿ï¼Œåæ˜¾ç¤ºCZSC

### è¾¹ç•Œæƒ…å†µ

1. **æ•°æ®ä¸è¶³**
   - å¦‚æœæ–°å‘¨æœŸKçº¿å¤ªå°‘ï¼ˆ<50æ ¹ï¼‰ï¼ŒCZSCå¯èƒ½æ— æ³•è®¡ç®—
   - ä¼šæ˜¾ç¤º"æ­£åœ¨è®¡ç®—..."æˆ–ç©ºç™½

2. **æ—¶é—´èŒƒå›´é—®é¢˜**
   - éªŒè¯é€»è¾‘å‡è®¾ç¬”çš„æ—¶é—´èŒƒå›´åº”åœ¨Kçº¿èŒƒå›´å†…
   - å¦‚æœKçº¿æ•°æ®æœ¬èº«æœ‰é—®é¢˜ï¼ŒéªŒè¯ä¹Ÿä¼šå¤±è´¥

## ğŸ“ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

1. âœ… `lib/ui/screens/main_screen.dart` - æ·»åŠ æŒ‡æ ‡æ¸…ç©ºé€»è¾‘
2. âœ… `lib/ui/chart/kline_painter.dart` - æ·»åŠ æ•°æ®éªŒè¯é€»è¾‘

## ğŸ”® æœªæ¥ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**
   - ç¼“å­˜ä¸åŒå‘¨æœŸçš„CZSCç»“æœ
   - åˆ‡æ¢å›å·²è®¡ç®—çš„å‘¨æœŸæ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜

2. **å¼‚æ­¥è®¡ç®—**
   - åœ¨åå°çº¿ç¨‹è®¡ç®—CZSC
   - ä¸é˜»å¡UIæ›´æ–°

3. **æ¸è¿›å¼æ˜¾ç¤º**
   - å…ˆæ˜¾ç¤ºKçº¿å’Œç®€å•æŒ‡æ ‡
   - CZSCè®¡ç®—å®Œæˆåå†æ˜¾ç¤º

4. **æ™ºèƒ½é‡ç”¨**
   - å¦‚æœæ–°å‘¨æœŸçš„æ•°æ®æ˜¯æ—§å‘¨æœŸçš„èšåˆ
   - å¯ä»¥å°è¯•é‡ç”¨éƒ¨åˆ†è®¡ç®—ç»“æœ

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-02-17  
**Bugä¸¥é‡ç¨‹åº¦**ï¼šé«˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•
